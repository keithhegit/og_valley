# Og Valley: 项目文档

## 1. 产品需求文档 (PRD)

### 1.1 产品概述
**Og Valley** 是一款基于 React 和现代 Web 技术构建的网页版农业 RPG，灵感来源于《星露谷物语》。它旨在提供即点即玩、无需下载的游戏体验，包含耕种、探索、战斗和经济系统。

### 1.2 核心玩法循环
1.  **资源获取**: 玩家消耗体力使用工具获取木材、石头、矿石。
2.  **农业生产**: 耕地 -> 播种 -> 浇水 -> 等待生长 -> 收获 -> 出售。
3.  **经济循环**: 出售作物/资源获取金币 -> 购买更多种子/升级工具 -> 扩大生产。
4.  **探索与生存**: 进入地下矿井，击败怪物，寻找珍稀矿石，寻找梯子下楼。

### 1.3 功能模块详情

#### 3.1 角色系统
- **属性**: HP (生命值), Energy (体力), Money (金钱)。
- **动作**: 4 方向移动 (WASD/箭头), 跑步动画, 工具使用动画。
- **交互**: 鼠标点击 (Click) 或键盘 (Space) 进行交互。
- **状态**: 体力耗尽无法工作，生命耗尽昏迷（丢失金钱/物品）。

#### 3.2 物品与库存
- **背包**: 24 格扩展背包，10 格快捷栏 (Hotbar)，支持滚轮/数字键切换。
- **堆叠**: 相同物品可堆叠 (999)。
- **丢弃/消耗**: 支持吃东西回复体力。
- **工具**: 斧头(Axe), 锄头(Hoe), 镐子(Pickaxe), 水壶(Can), 镰刀(Scythe), 武器(Sword), 钓竿(Rod)。

#### 3.3 地图与环境
- **多场景**:
  - **Farm**: 玩家大本营，包含耕地、房子、出货箱。
  - **House**: 室内场景，包含床、电视。
  - **Town**: NPC 活动区域。
  - **Mines**: 程序化生成的迷宫，每层随机刷新石头和怪物。
- **昼夜系统**: 时间流逝 (10分钟/tick)，晚上 2:00 AM 强制睡觉结算。
- **季节系统**: 春/夏/秋/冬 循环，影响作物生长。

#### 3.4 交互对象
- **障碍物**: 石头 (Stone), 树枝 (Twig), 杂草 (Weed), 矿脉 (Nodes)。
- **设施**: 出货箱 (Shipping Bin), 邮箱 (Mailbox), 传送门 (Warps)。
- **NPC**: 基础对话与好感度系统 (Gift/Talk)。

#### 3.5 美术与音效
- **风格**: 16-bit 像素风，完全复刻原版配色与比例。
- **渲染**: 使用 CSS/SVG 像素艺术组件，支持 16x16 和 16x32 (高物体) 混合渲染。
- **音频**: 使用 Web Audio API 实时合成 8-bit 音效 (无需素材文件)。

---

## 2. 技术架构

### 2.1 技术栈
-   **前端**: React 18 (Hooks + Functional Components)
-   **构建工具**: Vite
-   **语言**: TypeScript
-   **样式**: Tailwind CSS + Inline Styles (用于动态定位)
-   **图标**: Lucide React

### 2.2 部署与基础设施 (Cloudflare)
本项目采用 **Cloudflare 全栈架构** 进行构建与部署：

-   **Cloudflare Pages**: 
    -   用于托管前端静态资源 (React/Vite 构建产物)。
    -   提供全球 CDN 加速与自动 CI/CD 构建。
-   **Cloudflare R2**: 
    -   作为对象存储，存放游戏美术资源 (Sprite Sheets, 音频文件)。
    -   替代传统服务器文件存储，降低带宽成本。
    -   在 `constants.ts` 中配置 `ASSET_BASE_URL` 指向 R2 自定义域名。
-   **Cloudflare Workers**:
    -   (规划中) 用于处理后端逻辑，如多人游戏状态同步、排行榜或云存档 API。
    -   提供无服务器计算能力，低延迟响应。

### 2.3 核心架构
-   **游戏循环**: React State 驱动的伪实时循环。`useEffect` 处理定时器 (怪物, 浮动文字)，而用户输入触发即时状态更新。
-   **数据模型**:
    -   **ID 驱动**: 所有对象、物品和地块都由 `ITEM_DB` 中定义的整数 ID 引用。
    -   **网格系统**: `TileData[][]` 表示地图。
    -   **多场景**: 状态保存所有场景的网格数据 `Record<SceneName, TileData[][]>`。
-   **渲染**:
    -   **混合渲染器**: 使用基于 CSS 的像素艺术组件 (`PixelArt.tsx`)，根据物品 ID 进行映射。
    -   **虚拟 DOM**: React 高效地仅更新变化的图块。

### 2.4 数据结构
**物品数据库 (`ITEM_DB`)**:
静态配置表，将 ID 映射到属性 (名称, 类型, 精灵图, 属性)。
```typescript
const ITEM_DB = {
  2: { name: 'Stone Node', type: 'obstacle', drop: 390, ... },
  130: { name: 'Chest', type: 'container', slots: 9, ... },
  // ...
}
```

**状态管理**:
-   `player`: 位置, 属性, 库存。
-   `grids`: 所有场景的地图数据。
-   `containers`: 箱子的持久化存储 (`Scene_X_Y` 作为键)。
-   `monsters`: 活动实体数组。

---

## 3. 功能缺口分析 (更新于 2025-11-24 Phase 6 完成)

**Phase 6 已完成所有剩余功能！** ✅

### ✅ 高优先级功能 (100% 完成)
1-5: 时间系统、体力强制、死亡惩罚、食物系统、存档系统 - **全部完成**

### ✅ 中优先级功能 (100% 完成)
6. ✅ **工具使用动画** - 工具使用时角色弹跳动画
7. ✅ **玩家行走动画** - 2 帧行走循环
8. ✅ **音效系统** - 6 种操作音效 (dig/water/hit/pickup/step/plant)
9. ✅ **季节系统** - 28 天自动切换季节，作物季节验证
10. ✅ **House 室内场景** - 包含床、电视、箱子，可从农场进入

### ✅ 低优先级功能 (100% 完成)
11. ✅ **鼠标点击交互** - 点击相邻格子自动交互
12. ✅ **镰刀 (Scythe)** - ID 106, 0 体力消耗
13. ✅ **钓竿 (Rod)** - ID 107, 0 体力消耗
14. ✅ **特殊矿脉 Nodes** - 铜/铁/金矿脉 (ID 75/76/77)
15. ✅ **NPC 好感度系统** - 每日对话 +10 好感度 (最大 250)

### 📊 最终实现进度
- ✅ **已实现**: 15/15 (100%)
- ⚠️ **部分实现**: 0/15 (0%)
- ❌ **未实现**: 0/15 (0%)

**🎉 PRD 功能 100% 完成！**

---

## 4. 路线图与状态

### ✅ 第一阶段：基础建设 (已完成)
-   核心引擎 (网格, 玩家移动)
-   基础耕种 (耕地, 浇水, 收获)
-   资源采集 (树木, 岩石)

### ✅ 第二阶段：经济与数据 (已完成)
-   基于 ID 的物品系统 (`ITEM_DB`)
-   出货箱与邮箱商店
-   浮动文字反馈

### ✅ 第三阶段：库存与存储 (已完成)
-   [x] 完整背包 UI (按 'E' 键)
-   [x] 箱子系统 (放置/打开/存储)
-   [x] 拖拽物品管理
-   [x] 垃圾桶功能

### ✅ 第四阶段：世界与战斗 (已完成)
-   [x] 多场景架构 (农场, 城镇, 矿井)
-   [x] 传送点 (场景切换)
-   [x] 基础战斗 (剑 vs 史莱姆)
-   [x] 怪物 AI (简单追逐)

### ✅ 第五阶段：打磨与持久化 (已完成 - 2025-11-24)
-   [x] **时间系统**: 昼夜循环，每 tick 10 分钟，2:00 AM 强制睡觉。
-   [x] **体力管理**: 强制体力消耗，耗尽无法使用工具。
-   [x] **食物系统**: 添加可食用物品，右键点击回复体力。
-   [x] **玩家死亡**: HP 归零时昏迷，丢失 10% 金钱并传送回农场。
-   [x] **存档系统**: `localStorage` 持久化 (自动保存/加载)。
-   [x] **Bug 修复**: 修复自动转向、传送位置、添加物品提示。

### ✅ 第六阶段：完整功能集 (已完成 - 2025-11-24)
-   [x] **新物品**: 镰刀 (0体力), 钓竿, 铜/铁/金矿石。
-   [x] **矿脉系统**: 矿井随机生成特殊矿脉 (铜30%, 铁15%, 金5%)。
-   [x] **季节系统**: 28天自动换季，种植前验证作物季节。
-   [x] **House 场景**: 室内场景，包含床/电视/箱子。
-   [x] **鼠标交互**: 点击相邻格子自动面向并交互。
-   [x] **行走动画**: 2帧行走循环，移动时切换。
-   [x] **工具动画**: 使用工具时弹跳效果。
-   [x] **音效系统**: 6种操作音效 (dig/water/hit/pickup/step/plant)。
-   [x] **NPC 好感度**: 每日对话 +10 好感 (最大250)，显示💚反馈。

### 🔮 未来阶段
-   **第六阶段**: 季节系统、更多作物、House 室内场景。
-   **第七阶段**: NPC 日程表、好感度、送礼系统。
-   **第八阶段**: 房屋升级、家具、钓鱼小游戏。
